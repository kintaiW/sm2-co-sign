# SM2协同签名架构文档

## 系统概述

SM2协同签名系统基于密钥分片技术，将私钥分为D1（客户端）和D2（服务端）两部分，通过协同计算实现签名，确保私钥完整性。

---

## 一、安全模型

### 1.1 密钥分片

#### 分片原理
SM2协同签名采用双因子密钥分片方案：

- **D1 (客户端密钥分量)**: 32字节随机数，由客户端生成
- **D2 (服务端密钥分量)**: 32字节，由服务端生成
- **PA (公钥)**: 64字节压缩格式，通过计算得出

#### 数学关系
```
完整私钥 d = D1 + D2 (mod n)
公钥 PA = d × G = (D1 + D2) × G
       = D1 × G + D2 × G
       = P1 + P2

验证公式：PA = D1⁻¹ × P2 - G
```

#### 密钥存储保护

| 密钥 | 存储位置 | 加密方式 | 密钥长度 |
|------|---------|---------|---------|
| D1 | 客户端 | SM4(TMK) | 32字节 |
| D2 | 服务端 | SM4(LMK) | 32字节 |
| TMK | 客户端 | PBKDF2(PIN) | 32字节 |
| LMK | 服务端 | 内存/HSM | 32字节 |
| PA | 双方 | 明文 | 64字节 |

### 1.2 认证流程

#### 认证步骤

1. **客户端初始化**
   ```
   客户端 → 服务端: POST /cosign/challenge {usertag, apptag}
   服务端 → 客户端: {challenge[32], rhos[32]}
   ```

2. **挑战响应**
   ```
   客户端计算: hmac = SM3-HMAC(hmacKey, challenge)
   客户端 → 服务端: POST /cosign/init {hmac, usertag, apptag}
   ```

3. **令牌发放**
   ```
   服务端验证通过 → 发放 token[32]
   ```

#### 会话管理

- **Token生命周期**: 默认30分钟，可配置
- **挑战随机数有效期**: 5分钟
- **会话超时**: 空闲15分钟自动注销

### 1.3 密钥派生

#### TMK (Terminal Master Key)
```
TMK = PBKDF2-SHA256(PIN, apptag, 4096次迭代, 32字节输出)
```

#### Token派生密钥
```
TokenTMK = PBKDF2-SHA256(token, apptag, 4096次迭代, 32字节输出)
```

#### 加密密钥
```
加密D1: pri = SM4-CBC-Encrypt(TMK, D1, IV)
解密D1: D1 = SM4-CBC-Decrypt(TMK, pri, IV)
```

---

## 二、系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        应用层                                │
├──────────────────────┬──────────────────────────────────────┤
│  业务应用系统         │  管理控制台                          │
│  - 签名请求          │  - 密钥管理                          │
│  - 加密请求          │  - 终端管理                          │
│  - 验证请求          │  - 日志审计                          │
└──────────┬───────────┴───────────┬────────────────────────┘
           │                       │
           ▼                       ▼
┌──────────────────────┐  ┌──────────────────────────────────┐
│  客户端 SDK         │  │  HTTP API (管理端口: 6001)       │
│  (Rust)            │  │  - POST /cosign/terminal/*        │
│  - 密钥分片         │  │  - POST /cosign/key/*             │
│  - 密码计算         │  │  - POST /cert/*                   │
│  - 协议编解码       │  └──────────────────────────────────┘
│  - 会话管理         │
└──────────┬───────────┘
           │ HTTP/HTTPS
           ▼
┌─────────────────────────────────────────────────────────────┐
│                    服务端 (Go + Fiber)                       │
├─────────────────────────────────────────────────────────────┤
│  HTTP API (协同端口: 9001/9002)                            │
│  - POST /cosign/challenge                                    │
│  - POST /cosign/init                                         │
│  - POST /cosign/genkey                                       │
│  - POST /cosign/sign                                         │
│  - POST /cosign/decrypt                                      │
├─────────────────────────────────────────────────────────────┤
│  业务逻辑层                                                   │
│  - 认证模块     │  密钥管理模块      │  签名计算模块     │
│  - 会话模块     │  终端管理模块      │  解密计算模块     │
├─────────────────────────────────────────────────────────────┤
│  密码学抽象层                                                 │
│  - SM2/SM3/SM4  │  随机数生成        │  密钥派生函数     │
│  - KDF          │  HMAC              │  后量子算法       │
├─────────────────────────────────────────────────────────────┤
│  存储层                                                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ BadgerDB    │  │ Redis (缓存) │  │ 日志系统    │        │
│  │ - 终端信息   │  │ - 会话状态    │  │ - 操作审计   │        │
│  │ - 密钥数据   │  │ - Token      │  │ - 错误日志   │        │
│  │ - 证书数据   │  │ - 限流        │  │ - 性能指标   │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
├─────────────────────────────────────────────────────────────┤
│  密码学算法库                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ SDF C库     │  │ GM-TLS      │  │ gm-sdk-rs   │        │
│  │ (硬件支持)   │  │ (通信加密)   │  │ (客户端算法) │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 客户端架构

#### 模块划分

```
sm2-co-sign-client/
├── src/
│   ├── lib.rs                    # 公共API接口
│   ├── types.rs                  # 数据结构定义
│   ├── error.rs                  # 错误类型定义
│   ├── crypto/                   # 密码学模块
│   │   ├── mod.rs
│   │   ├── sm2.rs               # SM2算法封装
│   │   ├── sm3.rs               # SM3哈希算法
│   │   ├── sm4.rs               # SM4对称加密
│   │   ├── kdf.rs               # 密钥派生函数
│   │   └── hmac.rs              # HMAC计算
│   ├── http/                     # HTTP客户端模块
│   │   ├── mod.rs
│   │   ├── client.rs            # HTTP客户端封装
│   │   ├── types.rs             # API请求/响应类型
│   │   └── middleware.rs        # 中间件
│   ├── apdu/                     # APDU协议模块
│   │   ├── mod.rs
│   │   ├── encoder.rs           # APDU编码
│   │   ├── decoder.rs           # APDU解码
│   │   └── constants.rs         # 常量定义
│   ├── session/                  # 会话管理模块
│   │   ├── mod.rs
│   │   ├── manager.rs           # 会话管理器
│   │   └── token.rs             # Token处理
│   └── utils/                    # 工具函数
│       ├── mod.rs
│       ├── hex.rs               # 十六进制编解码
│       └── base64.rs            # Base64编解码
├── examples/                     # 示例代码
│   ├── init.rs
│   ├── gen_key.rs
│   ├── sign_verify.rs
│   └── encrypt_decrypt.rs
├── tests/                        # 集成测试
│   └── integration_test.rs
└── Cargo.toml
```

#### 核心类图

```
┌─────────────────────────────────────┐
│      Sm2CoSignClient                │
├─────────────────────────────────────┤
│ - http_client: CosignHttpClient    │
│ - crypto_client: Sm2CryptoClient   │
│ - session: SessionManager         │
│ - token: Option<Vec<u8>>          │
├─────────────────────────────────────┤
│ + init(usertag, apptag, hmac_key) │
│ + generate_key(pin, apptag)       │
│ + sign(token, d1, message)         │
│ + verify(public_key, message, sig)  │
│ + encrypt(public_key, message)     │
│ + decrypt(ciphertext)              │
└─────────────────────────────────────┘
             │
             │ 使用
             ▼
┌─────────────────────────────────────┐
│      CosignHttpClient              │
├─────────────────────────────────────┤
│ - client: reqwest::Client          │
│ - base_url: String                 │
├─────────────────────────────────────┤
│ + challenge(req) → Response        │
│ + init(req) → Result               │
│ + genkey(req) → Response           │
│ + sign(req) → Response             │
│ + decrypt(req) → Response           │
└─────────────────────────────────────┘
             │
             │ 使用
             ▼
┌─────────────────────────────────────┐
│      Sm2CryptoClient               │
├─────────────────────────────────────┤
│ - gm_sdk: GmSdk                    │
├─────────────────────────────────────┤
│ + generate_keypair()               │
│ + compute_temp_public_key(k)       │
│ + client_sign(d1, k, r, s2, s3, e) │
│ + decrypt_step0(d1, c1)            │
│ + verify_signature(pk, e, r, s)    │
└─────────────────────────────────────┘
```

### 2.3 服务端架构

#### 目录结构

```
sm2-co-sign-server/
├── src/
│   ├── cmd/
│   │   ├── server.go                # 服务入口
│   │   └── client.go                # 客户端模式入口
│   ├── internal/
│   │   ├── controller/
│   │   │   ├── terminal.go          # 终端管理
│   │   │   ├── key.go               # 密钥管理
│   │   │   ├── cert.go              # 证书管理
│   │   │   ├── sign.go              # 签名处理
│   │   │   └── decrypt.go           # 解密处理
│   │   ├── ocrypto/
│   │   │   ├── sm2.go               # SM2算法
│   │   │   ├── sm3.go               # SM3哈希
│   │   │   ├── sm4.go               # SM4加密
│   │   │   ├── kdf.go               # 密钥派生
│   │   │   ├── kyber.go             # Kyber算法
│   │   │   └── dilithium.go         # Dilithium算法
│   │   ├── storage/
│   │   │   ├── database.go          # 数据库接口
│   │   │   ├── badger.go            # BadgerDB实现
│   │   │   ├── terminal.go          # 终端数据
│   │   │   ├── key.go               # 密钥数据
│   │   │   └── cert.go              # 证书数据
│   │   ├── cfg/
│   │   │   ├── config.go            # 配置解析
│   │   │   └── types.go             # 配置类型
│   │   ├── auth/
│   │   │   ├── auth.go              # 认证逻辑
│   │   │   └── hmac.go              # HMAC验证
│   │   ├── session/
│   │   │   ├── manager.go           # 会话管理
│   │   │   └── token.go             # Token管理
│   │   └── middleware/
│   │       ├── logger.go            # 日志中间件
│   │       ├── recovery.go          # 恢复中间件
│   │       └── metrics.go           # 指标中间件
│   └── router/
│       ├── admin.go                 # 管理路由
│       └── cosign.go                # 协同签名路由
├── config/
│   ├── cosign.toml                  # 主配置文件
│   └── cosign.conf                  # C库配置
├── docs/
│   └── api.md                       # API文档
├── tests/
│   ├── integration/                 # 集成测试
│   └── unit/                        # 单元测试
├── go.mod
├── go.sum
├── Makefile
└── README.md
```

---

## 三、协同签名详细流程

### 3.1 密钥生成流程

```
┌─────────┐
│ 客户端   │
└────┬────┘
     │
     │ 1. 生成随机数 D1
     ▼
┌─────────────────────────────────┐
│ D1 = Random(32)                 │
│ P1 = D1 × G (65字节)            │
└────────────┬────────────────────┘
             │
             │ 2. 发送 P1
             ▼
┌─────────┐
│ 服务端   │
└────┬────┘
     │
     │ 3. 生成随机数 D2
     ▼
┌─────────────────────────────────┐
│ D2 = Random(32)                 │
│ P2 = D2 × G (65字节)            │
└────────────┬────────────────────┘
             │
             │ 4. 计算公钥
             ▼
┌─────────────────────────────────┐
│ PA = D1⁻¹ × P2 - G              │
│    (64字节压缩格式)              │
└────────────┬────────────────────┘
             │
             │ 5. 发送 P2
             ▼
┌─────────┐
│ 客户端   │
└────┬────┘
     │
     │ 6. 验证公钥
     ▼
┌─────────────────────────────────┐
│ 验证: PA ?= D1⁻¹ × P2 - G        │
│ PA_x = PA[1..33]                │
│ PA_y = PA[33..65]               │
│ 如果验证失败，报错               │
└─────────────────────────────────┘
```

### 3.2 协同签名流程

```
输入: 消息 message, 密钥对 (D1, D2, PA)

阶段1: 客户端预处理
─────────────────────────────
e = SM3(message)                      // 消息摘要
k = Random(32)                         // 随机数
Q1 = k × G                             // 临时公钥

阶段2: 服务端计算
─────────────────────────────
s2 = k × D2⁻¹ (mod n)                 // 签名分量2
s3 = k × PA_x⁻¹ (mod n)               // 签名分量3
r = (e + D1 × s2 + s3) (mod n)        // 签名分量r

阶段3: 客户端计算
─────────────────────────────
s = k⁻¹ × (e + D1 × r) (mod n)        // 签名分量s

输出: 签名 (r, s)

验证: SM2-Verify(PA, e, (r, s))
```

### 3.3 协同解密流程

```
输入: 密文 C = {C1, C2, C3}, 密钥对 (D1, D2)

阶段1: 客户端计算
─────────────────────────────
T1 = D1 × C1                           // 点乘

阶段2: 服务端计算
─────────────────────────────
T2 = D2⁻¹ × T1                         // 点乘逆运算

阶段3: 客户端解密
─────────────────────────────
x = KDF(T1 || T2 || C1)               // 密钥派生
M = SM4-Decrypt(x, C2)                 // 解密
验证: SM3-HMAC(x || M) ?= C3          // 完整性验证

输出: 明文 M
```

---

## 四、安全机制

### 4.1 防重放攻击

- **挑战随机数**: 每次认证使用不同的challenge
- **Token时效性**: Token有固定有效期
- **时间戳验证**: 请求包含时间戳，服务端验证时效性
- **Nonce机制**: 每次签名使用不同的随机数k

### 4.2 防中间人攻击

- **TLS加密**: 所有通信使用HTTPS
- **双向认证**: 支持客户端证书认证
- **HMAC签名**: 关键数据使用HMAC保护完整性

### 4.3 密钥保护

- **分片存储**: 私钥分片独立存储
- **加密存储**: 所有私钥在存储前加密
- **内存保护**: 敏感数据使用安全内存区域
- **最小权限**: 服务端只提供签名服务，无法恢复完整私钥

### 4.4 审计日志

- **操作日志**: 记录所有签名、解密操作
- **访问日志**: 记录所有API调用
- **错误日志**: 记录异常和错误
- **性能日志**: 记录响应时间等指标

---

## 五、性能指标

### 5.1 目标性能

| 操作 | 目标延迟 | 并发数 | 吞吐量 |
|------|---------|--------|--------|
| 密钥生成 | < 200ms | 100 | 500 req/s |
| 协同签名 | < 100ms | 1000 | 5000 req/s |
| 协同解密 | < 150ms | 500 | 2000 req/s |
| 验签 | < 10ms | 5000 | 20000 req/s |

### 5.2 资源占用

| 组件 | CPU | 内存 | 存储 |
|------|-----|------|------|
| 服务端 | < 10% | < 512MB | < 1GB |
| 客户端 | < 5% | < 64MB | < 10MB |

---

## 六、部署架构

### 6.1 单机部署

```
┌─────────────────────────────────┐
│        应用服务器               │
├─────────────────────────────────┤
│  ┌─────────────────────────┐   │
│  │   Nginx / HAProxy      │   │
│  │   (反向代理 + SSL)      │   │
│  └────────────┬────────────┘   │
│               │                │
│  ┌────────────▼────────────┐  │
│  │   sm2-co-sign-server    │  │
│  │   (Go 服务)              │  │
│  └────────────┬────────────┘  │
│               │                │
│  ┌────────────▼────────────┐  │
│  │   BadgerDB / Redis       │  │
│  └─────────────────────────┘  │
└─────────────────────────────────┘
```

### 6.2 集群部署

```
                    ┌─────────┐
                    │  负载   │
                    │  均衡器  │
                    └────┬────┘
         ┌───────────────┼──────────────┐
         ▼               ▼               ▼
    ┌────────┐      ┌────────┐     ┌────────┐
    │Server1 │      │Server2 │     │Server3 │
    └───┬────┘      └───┬────┘     └───┬────┘
        │               │               │
        └───────────────┼───────────────┘
                        │
                        ▼
                 ┌──────────────┐
                 │  共享存储     │
                 │  (NFS/Ceph)   │
                 └──────────────┘
```

---

## 七、监控与运维

### 7.1 监控指标

- **系统指标**: CPU、内存、磁盘、网络
- **应用指标**: 请求量、响应时间、错误率
- **业务指标**: 签名次数、密钥数量、活跃用户

### 7.2 告警策略

- **高优先级**: 服务不可用、数据库连接失败
- **中优先级**: 响应时间过长、错误率升高
- **低优先级**: 磁盘空间不足、证书即将过期

### 7.3 日志管理

- **日志级别**: DEBUG/INFO/WARN/ERROR
- **日志格式**: JSON格式，便于解析
- **日志保留**: 根据合规要求保留30-90天
- **日志分析**: 使用ELK/Loki等日志分析系统
