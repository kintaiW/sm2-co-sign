# SM2 协同签名系统架构文档

## 系统概述

SM2 协同签名系统基于密钥分片技术，将私钥分为 D1（客户端）和 D2（服务端）两部分，通过协同计算实现签名，确保私钥完整性。

## 一、系统架构

### 1.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        应用层                                │
├──────────────────────┬──────────────────────────────────────┤
│  业务应用系统         │  Web 管理控制台                      │
│  - 签名请求          │  - 密钥管理                          │
│  - 加密请求          │  - 用户管理                          │
│  - 验证请求          │  - 日志审计                          │
└──────────┬───────────┴───────────┬────────────────────────┘
           │                       │
           ▼                       ▼
┌──────────────────────┐  ┌──────────────────────────────────┐
│  客户端 SDK         │  │  HTTP API (管理端口)             │
│  (Rust)            │  │  - GET /mapi/users               │
│  - 密钥分片         │  │  - GET /mapi/keys                │
│  - 密码计算         │  │  - GET /mapi/logs                │
│  - FFI 接口         │  └──────────────────────────────────┘
└──────────┬───────────┘
           │ HTTP/HTTPS
           ▼
┌─────────────────────────────────────────────────────────────┐
│                    服务端 (Go + Fiber)                       │
├─────────────────────────────────────────────────────────────┤
│  HTTP API (业务端口: 9002)                                  │
│  - POST /api/register    用户注册                           │
│  - POST /api/login       用户登录                           │
│  - POST /api/sign        协同签名                            │
│  - POST /api/decrypt     协同解密                            │
├─────────────────────────────────────────────────────────────┤
│  业务逻辑层                                                   │
│  - 认证模块     │  密钥管理模块      │  签名计算模块          │
│  - 会话模块     │  用户管理模块      │  解密计算模块          │
├─────────────────────────────────────────────────────────────┤
│  密码学抽象层                                                 │
│  - SM2/SM3/SM4  │  随机数生成        │  密钥派生函数          │
├─────────────────────────────────────────────────────────────┤
│  存储层                                                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ SQLite      │  │ 会话管理     │  │ 审计日志    │        │
│  │ - 用户数据   │  │ - Token      │  │ - 操作审计   │        │
│  │ - 密钥数据   │  │ - 会话状态    │  │ - 错误日志   │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 技术栈

| 组件 | 技术栈 | 版本 |
|------|--------|------|
| **服务端** | Go + Fiber v2 | Go 1.24 |
| **客户端** | Rust + libsm | Rust 2021 |
| **前端** | React + Ant Design | React 18 |
| **数据库** | SQLite | 纯 Go 实现 |
| **密码算法** | gmsm / libsm | SM2/SM3/SM4 |

## 二、密钥分片架构

### 2.1 密钥生成流程

```
客户端                                服务端
  |                                     |
  |-- 1. 生成 d1 (随机数)               |
  |-- 2. 计算 P1 = d1 * G              |
  |                                     |
  |--- POST /api/register {p1} ------->|
  |                                     |-- 3. 生成 d2 (随机数)
  |                                     |-- 4. 计算 d2Inv = d2^(-1) mod n
  |                                     |-- 5. 计算 P2 = d2Inv * G
  |                                     |-- 6. 计算 Pa = d2Inv * P1 + (n-1) * G
  |                                     |-- 7. 存储 (userId, d2, d2Inv, Pa)
  |<--- {userId, p2, pa} --------------|
  |                                     |
  |-- 8. 计算 d = d1 * d2 - 1           |
  |-- 9. 存储本地 (d1, userId, pa)      |
```

### 2.2 数学关系

```
完整私钥: d = d1 * d2 - 1 (不存储)
公钥: Pa = d2Inv * P1 + (n-1) * G

验证公式:
Pa = d2Inv * P1 - G
   = d2Inv * d1 * G - G
   = (d1 * d2Inv - 1) * G
   = d * G
```

### 2.3 密钥存储保护

| 密钥 | 存储位置 | 加密方式 | 长度 |
|------|---------|---------|------|
| D1 | 客户端 | 本地加密存储 | 32字节 |
| D2 | 服务端 | 主密钥加密 | 32字节 |
| D2Inv | 服务端 | 主密钥加密 | 32字节 |
| PA | 双方 | 明文 | 64字节 |

## 三、协同签名流程

### 3.1 签名流程

```
客户端                                服务端
  |                                     |
  |-- 1. 计算消息哈希 E = SM3(M)        |
  |-- 2. 生成随机数 k1                  |
  |-- 3. 计算 Q1 = k1 * G              |
  |                                     |
  |--- POST /api/sign {q1, e} --------->|
  |                                     |-- 4. 生成随机数 k2, k3
  |                                     |-- 5. 计算 Q2 = k2 * G
  |                                     |-- 6. 计算 x1 = k3 * Q1 + Q2
  |                                     |-- 7. 计算 r = (E + x1) mod n
  |                                     |-- 8. 计算 s2 = d2Inv * k3 mod n
  |                                     |-- 9. 计算 s3 = d2Inv * (r + k2) mod n
  |<--- {r, s2, s3} -------------------|
  |                                     |
  |-- 10. 计算 s1 = k1 * s3 - r * d1    |
  |-- 11. 计算 s = s1 * s2 mod n        |
  |-- 12. 最终签名 (r, s)               |
```

### 3.2 验签

使用标准 SM2 验签算法验证签名 (r, s)。

## 四、协同解密流程

### 4.1 解密流程

```
客户端                                服务端
  |                                     |
  |-- 1. 解析密文 C1||C3||C2            |
  |-- 2. 计算 T1 = d1 * C1             |
  |                                     |
  |--- POST /api/decrypt {t1} --------->|
  |                                     |-- 3. 计算 T2 = d2Inv * T1
  |<--- {t2} ---------------------------|
  |                                     |
  |-- 4. 计算 K = SM3(T2)              |
  |-- 5. 解密明文 M = C2 XOR K         |
```

## 五、安全机制

### 5.1 防重放攻击

- **挑战随机数**: 登录时使用挑战-响应机制
- **Token 时效性**: Token 有固定有效期（默认 24 小时）
- **Nonce 机制**: 每次签名使用不同的随机数

### 5.2 密钥保护

- **分片存储**: 私钥分片独立存储，完整私钥永不出现
- **加密存储**: 服务端密钥分量使用主密钥加密
- **最小权限**: 服务端只提供签名服务，无法恢复完整私钥

### 5.3 审计日志

- **操作日志**: 记录所有签名、解密操作
- **访问日志**: 记录所有 API 调用
- **错误日志**: 记录异常和错误

## 六、部署架构

### 6.1 单机部署

```
┌─────────────────────────────────┐
│        应用服务器               │
├─────────────────────────────────┤
│  ┌─────────────────────────┐   │
│  │   Nginx (反向代理+SSL)   │   │
│  └────────────┬────────────┘   │
│               │                │
│  ┌────────────▼────────────┐  │
│  │   sm2-co-sign-server    │  │
│  │   (Go 服务)              │  │
│  └────────────┬────────────┘  │
│               │                │
│  ┌────────────▼────────────┐  │
│  │   SQLite 数据库          │  │
│  └─────────────────────────┘  │
└─────────────────────────────────┘
```

### 6.2 性能指标

| 操作 | 目标延迟 | 并发数 | 吞吐量 |
|------|---------|--------|--------|
| 密钥生成 | < 200ms | 100 | 500 req/s |
| 协同签名 | < 100ms | 1000 | 5000 req/s |
| 协同解密 | < 150ms | 500 | 2000 req/s |
| 验签 | < 10ms | 5000 | 20000 req/s |

## 七、许可证

Apache License 2.0
